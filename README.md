# 门店报表查询系统

## 系统概述

这是一个基于Streamlit和MongoDB的门店报表查询系统，支持：

- 🏪 多门店数据管理
- 📊 应收未收金额可视化看板
- 📈 财务报表分析和可视化
- 📤 批量Excel报表上传
- 🔐 门店密码验证访问控制

## 功能特点

### 1. 门店查询系统 (enhanced_app.py)
- **应收未收看板**: 显示第82行合计列的应收未收金额
  - 负值显示为"总部应退"金额（红色）
  - 正值显示为"门店应付"金额（橙色）
  - 零值显示为"已结清"（绿色）
- **财务分析**: 收入、成本、利润趋势分析
- **多月份对比**: 支持选择多个月份进行对比分析
- **实时数据**: 快速查询和精确显示

### 2. 批量上传系统 (bulk_uploader.py)
- **Excel文件处理**: 支持大文件上传，通过sheet名称识别门店
- **进度显示**: 实时显示上传进度和处理状态
- **结果统计**: 详细显示成功/失败数量和处理时间
- **智能匹配**: 自动匹配sheet名称到门店信息
- **数据验证**: 自动提取第82行合计列的应收未收金额

## 安装和使用

### 1. 环境准备

```bash
# 进入项目目录
cd /Users/yuecao/store_report_system

# 安装依赖
pip install -r requirements.txt
```

### 2. 数据库配置

创建`.env`文件配置MongoDB连接：

```env
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/
DATABASE_NAME=store_reports
SECRET_KEY=your_secret_key_here
```

### 3. 启动应用

```bash
# 使用启动脚本（推荐）
python start_app.py

# 或单独启动应用
# 门店查询系统
streamlit run enhanced_app.py --server.port=8501

# 批量上传系统  
streamlit run bulk_uploader.py --server.port=8502
```

### 4. 访问地址

- 门店查询系统: http://localhost:8501
- 批量上传系统: http://localhost:8502

## 数据结构

### MongoDB集合结构

#### 1. stores (门店信息)
```json
{
  "_id": "store_001",
  "store_name": "犀牛百货滨江店",
  "store_code": "bj001", 
  "password": "123456",
  "region": "杭州",
  "manager": "张三",
  "aliases": ["滨江店", "滨江"]
}
```

#### 2. reports (报表数据)
```json
{
  "_id": "ObjectId",
  "store_id": "store_001",
  "store_code": "bj001",
  "report_month": "2024-08",
  "financial_data": {
    "receivables": {
      "net_amount": -15000.50  // 第82行合计列的值
    },
    "revenue": {...},
    "cost": {...},
    "profit": {...}
  }
}
```

## Excel文件格式要求

### 1. 文件结构
- 每个工作表(sheet)代表一个门店
- 工作表名称应包含门店标识信息
- 第82行的"合计"列包含应收未收金额

### 2. 数据识别
- **应收未收金额**: 第82行合计列
  - 负值 → 总部应退金额
  - 正值 → 门店应付金额
- **其他财务数据**: 根据行标签自动识别收入、成本、利润等

### 3. 门店匹配
系统会自动匹配以下格式的工作表名称：
- "犀牛百货(滨江店)"
- "滨江店"
- "犀牛百货滨江店"

## 使用流程

### 管理员操作
1. 访问批量上传系统(8502端口)
2. 选择报表月份
3. 上传包含所有门店数据的Excel文件
4. 查看上传结果和统计信息

### 门店用户操作
1. 访问门店查询系统(8501端口)
2. 输入门店代码和查询密码
3. 选择要查询的月份
4. 查看应收未收看板和财务报表

## 系统特色

### 1. 高性能
- MongoDB索引优化
- 缓存机制
- 并行数据处理

### 2. 用户友好
- 中文界面
- 直观的可视化图表
- 实时进度反馈

### 3. 数据安全
- 门店密码验证
- 数据访问隔离
- 操作日志记录

### 4. 可扩展性
- 支持数百个门店
- 灵活的数据结构
- 模块化设计

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查`.env`文件中的MongoDB连接配置
   - 确认网络连接正常

2. **门店匹配失败**
   - 检查工作表名称格式
   - 在数据库中添加门店别名

3. **应收未收金额显示异常**
   - 确认Excel第82行合计列有数据
   - 检查数据格式是否为数值

4. **上传速度慢**
   - 确认文件大小和网络状况
   - 尝试分批上传

## 技术栈

- **前端**: Streamlit
- **数据库**: MongoDB
- **数据处理**: Pandas
- **可视化**: Plotly
- **语言**: Python 3.8+

## 更新日志

### v1.0.0 (2024-08-21)
- 初始版本发布
- 支持应收未收金额看板
- 批量Excel上传功能
- 门店查询和分析功能