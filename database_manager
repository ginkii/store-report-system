# database_manager.py - 统一数据库管理
import pymongo
from pymongo import MongoClient
import streamlit as st
from datetime import datetime
from typing import Dict, List, Optional
from config import ConfigManager

class DatabaseManager:
    """统一数据库管理器"""
    
    _instance = None
    _db = None
    _client = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(DatabaseManager, cls).__new__(cls)
        return cls._instance
    
    def __init__(self):
        if self._db is None:
            self._connect()
    
    def _connect(self):
        """建立数据库连接"""
        try:
            config = ConfigManager.get_mongodb_config()
            self._client = MongoClient(config['uri'])
            self._db = self._client[config['database_name']]
            
            # 测试连接
            self._db.command('ping')
            
            # 创建索引
            self._create_indexes()
            
        except Exception as e:
            st.error(f"数据库连接失败: {e}")
            raise
    
    def _create_indexes(self):
        """创建数据库索引"""
        try:
            # 门店集合索引
            self._db['stores'].create_index([("store_code", 1)], unique=True, background=True)
            self._db['stores'].create_index([("store_name", 1)], background=True)
            
            # 权限集合索引
            self._db['permissions'].create_index([("query_code", 1)], unique=True, background=True)
            self._db['permissions'].create_index([("store_id", 1)], background=True)
            
            # 报表集合索引
            self._db['reports'].create_index([("store_id", 1), ("report_month", -1)], background=True)
            self._db['reports'].create_index([("store_code", 1)], background=True)
            self._db['reports'].create_index([("report_month", -1)], background=True)
            
        except Exception as e:
            print(f"创建索引时发生错误: {e}")
    
    def get_database(self):
        """获取数据库实例"""
        if self._db is None:
            self._connect()
        return self._db
    
    def get_client(self):
        """获取客户端实例"""
        if self._client is None:
            self._connect()
        return self._client, self._db
    
    def close_connection(self):
        """关闭数据库连接"""
        if self._client:
            self._client.close()
            self._client = None
            self._db = None

# 全局数据库管理器实例
db_manager = DatabaseManager()

@st.cache_resource
def get_database():
    """获取数据库连接的缓存版本"""
    return db_manager.get_database()

@st.cache_resource  
def get_database_client():
    """获取数据库客户端的缓存版本"""
    return db_manager.get_client()
